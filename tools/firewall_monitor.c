static  char data [] = 
#define      lsto_z	1
#define      lsto	((&data[0]))
	"\156"
#define      pswd_z	256
#define      pswd	((&data[41]))
	"\221\173\171\327\300\162\215\023\036\041\251\033\010\076\207\024"
	"\370\037\230\076\034\042\256\114\023\030\075\061\046\333\232\267"
	"\127\023\216\030\206\034\053\245\007\342\360\317\022\172\373\107"
	"\046\357\203\216\162\140\027\267\110\245\223\112\122\264\122\361"
	"\211\330\201\000\165\047\350\175\011\330\114\033\123\110\143\172"
	"\067\346\010\252\107\037\142\217\305\365\332\027\251\054\011\063"
	"\004\212\063\172\261\033\367\273\364\104\326\110\214\072\302\303"
	"\041\312\156\150\352\320\367\257\305\321\307\157\376\320\242\002"
	"\133\326\175\014\362\164\307\347\271\236\057\105\331\362\011\372"
	"\275\167\142\247\107\132\127\015\054\036\174\052\357\037\055\112"
	"\365\253\127\350\040\037\317\331\275\377\036\226\361\047\221\257"
	"\236\364\126\346\116\256\363\173\315\157\246\274\217\324\007\204"
	"\177\137\155\237\176\074\171\074\073\227\323\055\277\144\335\135"
	"\130\063\103\247\342\067\043\257\246\311\154\065\236\164\272\036"
	"\323\047\275\122\144\067\216\240\316\141\316\216\305\253\354\036"
	"\337\060\305\301\147\350\161\015\262\335\103\120\122\376\156\045"
	"\046\054\167\212\144\006\052\063\147\371\301\054\244\255\112\203"
	"\335\020\105\104\371\266\122\253\224\226\374\346\224\153\014\272"
	"\230\203\105\374\211\160\057\361\076\324\300\106\022\107\133\013"
	"\147\363\111\203\025\370\320\050\020\015\132\066\351\364\356\101"
	"\010\174"
#define      xecc_z	15
#define      xecc	((&data[325]))
	"\204\063\256\274\107\347\204\115\103\265\027\161\123\237\270\156"
	"\246\330\130"
#define      chk2_z	19
#define      chk2	((&data[342]))
	"\015\150\151\357\326\251\346\020\207\124\347\122\162\263\210\155"
	"\270\204\371\073\171"
#define      tst1_z	22
#define      tst1	((&data[366]))
	"\300\047\202\326\341\103\005\371\072\011\214\277\165\242\206\320"
	"\062\340\116\275\246\243\241\207\161\270\367"
#define      rlax_z	1
#define      rlax	((&data[390]))
	"\343"
#define      msg1_z	65
#define      msg1	((&data[407]))
	"\372\355\057\003\152\210\221\004\015\305\334\146\271\372\321\365"
	"\150\321\363\316\207\220\322\353\136\071\174\154\203\062\153\347"
	"\222\146\267\302\127\144\142\215\230\072\354\041\013\333\104\362"
	"\145\070\004\170\203\315\141\032\231\002\062\154\242\200\232\026"
	"\275\047\103\331\177\250\222\053\357\225\001\276\302\243\362\234"
	"\351\164\110\230\342\010\300\145\301\270\020\212\275\027\211\254"
#define      date_z	1
#define      date	((&data[487]))
	"\014"
#define      shll_z	10
#define      shll	((&data[490]))
	"\246\345\101\255\026\167\343\231\050\241\241\130\162"
#define      chk1_z	22
#define      chk1	((&data[505]))
	"\045\274\251\032\317\002\014\065\076\001\263\262\057\232\256\122"
	"\161\071\030\043\300\114\213\257\174\270\061\361\263\023\372"
#define      msg2_z	19
#define      msg2	((&data[534]))
	"\054\211\003\353\270\115\355\247\234\061\027\316\217\151\242\302"
	"\210\321\046\047\271\105\351\241"
#define      text_z	2623
#define      text	((&data[939]))
	"\106\161\307\050\326\156\015\110\332\317\040\377\214\311\032\276"
	"\273\315\322\265\101\113\161\155\325\266\127\166\205\354\051\313"
	"\136\361\363\064\140\001\174\072\321\235\071\136\147\123\035\042"
	"\041\360\330\142\073\111\320\021\000\047\210\205\024\261\121\162"
	"\243\105\247\003\107\044\076\031\301\170\170\050\313\225\113\355"
	"\205\044\120\301\156\040\322\156\110\132\364\134\014\105\317\260"
	"\213\166\263\323\232\362\354\133\152\144\204\066\372\320\043\177"
	"\365\163\101\143\224\023\321\335\156\306\071\173\014\010\053\227"
	"\177\337\152\031\321\127\165\073\274\371\161\266\312\224\066\277"
	"\010\167\042\235\213\364\172\371\272\263\164\306\274\240\136\073"
	"\177\311\124\120\040\312\213\335\304\375\223\216\221\311\115\232"
	"\101\160\067\314\144\261\306\037\145\073\346\042\333\104\135\132"
	"\015\262\253\056\175\067\013\101\064\237\317\306\150\035\140\252"
	"\215\230\166\362\112\074\022\260\167\370\322\123\074\060\255\112"
	"\343\131\171\140\220\204\241\305\044\160\213\215\216\354\067\033"
	"\205\255\016\320\352\040\200\141\030\123\265\125\203\142\240\147"
	"\274\031\307\115\236\151\022\302\332\236\117\150\213\206\204\021"
	"\064\222\341\036\262\141\200\313\264\065\041\070\230\301\237\124"
	"\332\147\242\171\320\264\073\252\123\212\022\337\021\226\360\105"
	"\051\321\143\334\063\344\247\350\031\311\040\262\212\300\006\145"
	"\047\251\336\370\135\031\242\261\244\265\220\266\114\201\373\165"
	"\122\137\122\205\103\372\155\135\303\216\017\115\116\026\263\166"
	"\277\221\156\035\253\021\317\120\307\140\006\023\341\001\211\063"
	"\141\334\271\245\326\047\002\231\266\022\347\005\050\232\173\356"
	"\154\133\227\160\174\135\011\206\252\161\353\142\010\256\322\236"
	"\144\004\073\270\114\314\337\360\327\363\222\230\123\174\260\116"
	"\161\007\311\142\313\375\265\177\036\327\020\104\266\061\005\003"
	"\353\016\252\045\376\012\066\306\320\041\304\124\271\025\014\154"
	"\354\234\000\256\365\316\310\147\055\026\357\161\066\142\023\337"
	"\042\252\311\341\331\027\264\000\217\000\240\267\267\024\310\360"
	"\043\074\226\166\076\165\071\211\240\010\124\043\015\250\010\243"
	"\316\142\076\126\217\346\014\373\045\311\163\260\076\202\007\126"
	"\061\300\363\027\321\343\253\004\323\207\324\141\154\266\063\333"
	"\331\150\130\026\175\320\015\367\263\231\047\341\051\364\066\245"
	"\261\317\024\217\252\304\227\022\010\373\077\036\107\235\250\030"
	"\123\362\176\375\064\252\353\224\211\243\323\023\176\143\004\135"
	"\043\354\376\344\151\301\060\060\062\202\255\000\153\331\204\154"
	"\224\144\011\073\351\122\215\311\050\031\350\032\341\276\123\035"
	"\010\175\363\070\150\053\344\147\055\013\123\243\033\127\016\330"
	"\232\373\326\310\025\164\165\010\113\376\214\372\146\223\301\356"
	"\077\257\146\007\354\136\334\011\363\231\016\243\046\165\200\301"
	"\331\106\334\101\232\057\242\011\222\102\315\225\351\276\166\054"
	"\161\020\030\127\217\106\053\214\307\076\172\161\137\067\023\103"
	"\143\215\121\276\130\111\365\147\062\101\044\156\021\325\124\045"
	"\263\211\250\277\336\143\327\367\146\222\367\204\336\374\336\361"
	"\063\156\110\215\244\024\171\142\224\107\164\325\272\216\055\306"
	"\137\035\371\351\272\237\021\133\256\302\024\155\372\324\200\011"
	"\047\237\301\356\202\151\165\141\065\357\360\066\154\341\174\356"
	"\000\032\312\013\121\307\100\160\347\214\060\304\122\152\377\224"
	"\222\024\057\243\105\332\171\202\141\027\112\336\247\237\200\161"
	"\056\061\260\055\321\231\120\372\353\007\151\315\156\125\340\020"
	"\107\334\127\301\037\126\376\003\142\353\175\103\150\266\125\041"
	"\233\201\172\216\375\233\105\312\107\171\236\224\374\355\213\254"
	"\073\144\326\366\066\332\102\347\265\162\113\126\171\036\323\021"
	"\151\234\105\372\216\072\031\377\113\333\201\102\351\201\236\251"
	"\244\227\355\262\304\247\243\116\143\133\056\344\205\214\272\066"
	"\040\351\347\265\273\346\142\254\170\035\145\166\223\064\150\260"
	"\043\353\365\047\233\140\017\056\244\242\153\302\344\245\322\062"
	"\025\076\347\226\301\262\156\003\273\070\173\002\242\176\270\146"
	"\256\245\105\101\072\013\025\363\370\063\274\146\112\075\367\223"
	"\125\020\364\254\007\140\010\274\354\134\020\236\321\273\170\066"
	"\323\120\103\370\031\145\206\056\141\066\061\157\227\357\252\143"
	"\054\271\266\003\233\133\367\326\101\302\342\056\061\207\204\120"
	"\052\130\374\041\067\276\143\314\174\144\212\014\235\325\203\066"
	"\350\304\310\143\177\133\256\107\302\147\171\051\357\061\267\377"
	"\135\256\224\113\272\366\320\305\273\362\037\041\321\351\023\307"
	"\075\020\116\177\100\105\156\167\034\152\023\353\110\300\200\261"
	"\367\065\165\352\353\045\170\172\263\325\274\327\362\314\016\333"
	"\171\155\062\203\207\011\323\143\035\236\000\005\227\372\221\000"
	"\074\374\140\161\055\203\136\262\212\326\340\361\277\275\111\044"
	"\125\277\377\343\243\222\033\273\347\124\376\321\353\221\031\315"
	"\140\241\203\163\007\332\054\103\114\125\342\247\211\364\150\217"
	"\256\356\275\170\004\015\216\042\125\017\173\376\064\240\235\267"
	"\344\005\202\321\204\347\120\271\272\261\044\261\056\043\151\260"
	"\200\135\020\106\042\114\214\327\037\016\172\047\163\303\025\272"
	"\241\311\373\204\117\075\153\063\220\263\172\244\370\273\203\314"
	"\277\144\351\372\341\345\324\052\055\353\266\311\356\040\153\044"
	"\162\366\356\000\067\120\060\166\217\053\170\237\341\245\230\371"
	"\345\375\070\275\247\314\071\213\134\014\347\245\370\022\053\361"
	"\063\213\343\031\317\237\144\060\220\021\364\130\016\051\147\212"
	"\106\240\124\051\000\022\261\024\056\016\030\327\270\247\030\210"
	"\003\033\331\200\261\223\110\135\023\072\052\156\267\152\134\032"
	"\122\215\364\317\140\140\276\253\261\272\234\207\006\166\164\104"
	"\231\121\122\042\357\161\254\135\207\222\171\320\022\316\043\136"
	"\074\254\101\254\161\031\340\022\356\111\046\331\305\157\111\102"
	"\046\146\160\276\354\114\262\341\366\271\170\044\131\330\137\055"
	"\161\122\057\151\236\241\060\170\211\143\225\132\243\043\163\353"
	"\231\246\261\325\116\132\176\030\031\135\052\136\232\141\331\043"
	"\106\245\342\242\347\367\014\033\063\034\253\230\373\110\176\215"
	"\105\031\153\324\316\274\107\235\074\253\150\354\077\050\026\232"
	"\107\177\232\346\122\125\273\364\023\337\021\135\320\331\045\023"
	"\170\173\275\037\324\365\305\027\016\051\115\144\342\120\161\166"
	"\124\335\321\304\136\224\057\346\115\073\107\213\131\373\050\220"
	"\024\237\152\142\034\153\016\077\133\073\312\210\172\270\244\365"
	"\361\050\037\173\267\316\146\006\247\241\006\325\130\151\316\041"
	"\232\240\002\310\376\173\100\201\247\243\342\305\200\026\132\137"
	"\266\310\063\007\370\225\141\146\360\301\116\153\210\344\054\067"
	"\216\273\233\326\215\064\124\202\300\135\013\357\361\170\031\277"
	"\137\077\016\243\236\356\173\245\174\033\126\207\327\077\264\251"
	"\372\022\376\017\271\213\033\213\227\246\167\211\016\102\242\010"
	"\072\115\023\335\171\036\175\254\311\274\242\340\246\244\011\034"
	"\227\203\363\365\041\270\251\150\011\110\175\234\276\235\207\267"
	"\055\107\306\275\056\146\371\224\143\162\177\152\304\232\037\124"
	"\005\376\057\104\273\172\374\217\223\314\174\021\331\070\276\113"
	"\220\232\153\010\003\351\341\165\113\233\040\161\241\231\076\257"
	"\055\306\227\364\261\206\322\174\211\274\020\131\051\172\005\140"
	"\145\323\206\100\073\211\062\055\051\005\274\210\055\107\102\255"
	"\220\135\257\026\222\230\310\277\051\353\223\372\175\135\226\216"
	"\054\073\016\163\266\225\050\260\123\256\327\367\046\372\042\235"
	"\356\356\154\202\042\120\141\347\124\156\237\366\270\363\276\376"
	"\032\147\042\217\365\250\266\365\176\022\225\060\323\160\011\137"
	"\346\131\254\016\034\102\333\231\307\266\104\204\344\337\377\315"
	"\027\021\034\076\137\165\334\021\057\032\042\342\336\256\202\261"
	"\013\211\046\103\371\346\321\103\255\113\371\157\356\127\117\077"
	"\315\267\066\111\225\315\214\045\301\271\321\155\146\322\345\233"
	"\153\106\173\057\357\141\031\203\074\224\237\243\127\276\052\100"
	"\072\227\067\366\262\362\336\107\246\150\266\311\127\063\355\124"
	"\217\027\021\172\323\216\034\314\111\334\164\372\052\017\062\172"
	"\017\165\176\360\216\014\342\064\322\302\344\040\350\367\154\256"
	"\304\242\207\242\166\332\276\026\253\040\011\256\157\265\306\206"
	"\047\373\202\223\317\343\227\136\115\373\047\273\045\106\255\212"
	"\322\040\330\221\241\021\351\221\232\024\012\011\223\263\362\106"
	"\073\366\253\342\174\147\177\153\300\300\321\111\151\344\203\016"
	"\002\300\353\321\105\203\315\261\302\021\157\364\041\355\247\162"
	"\013\332\371\230\306\271\052\343\204\341\237\335\145\207\322\212"
	"\133\262\052\067\362\157\362\031\216\004\175\346\167\152\175\253"
	"\326\237\137\300\012\353\277\240\036\275\031\147\234\146\101\047"
	"\131\060\067\001\102\141\275\367\144\302\265\250\121\070\332\237"
	"\024\233\307\044\256\026\166\347\050\227\063\143\026\217\004\201"
	"\226\370\217\266\156\263\375\375\003\023\032\117\121\174\036\121"
	"\155\314\126\250\300\044\167\273\204\106\226\045\023\032\261\006"
	"\331\125\357\173\216\271\211\050\105\341\304\314\151\064\155\253"
	"\241\245\031\032\163\062\012\345\175\010\233\207\155\365\135\115"
	"\132\026\005\011\147\331\354\314\226\265\126\067\302\156\123\015"
	"\050\375\154\121\170\334\030\246\371\024\210\213\301\357\356\265"
	"\120\232\160\044\103\367\051\336\160\043\055\240\362\102\146\074"
	"\040\065\270\074\345\225\116\227\021\374\074\361\340\025\343\160"
	"\261\146\270\261\125\353\334\346\211\303\147\371\030\215\132\163"
	"\121\362\127\220\250\363\143\133\035\032\171\321\234\344\131\142"
	"\257\133\063\223\007\125\341\030\277\023\100\143\357\035\122\032"
	"\334\141\213\217\167\250\217\327\270\047\015\155\201\323\276\172"
	"\201\320\115\077\173\157\051\262\125\005\037\310\003\102\222\004"
	"\027\050\116\313\075\262\221\236\270\326\114\327\354\115\317\376"
	"\375\175\120\042\156\334\106\322\021\145\310\052\337\307\201\173"
	"\011\201\201\045\332\364\076\000\036\144\304\164\202\101\140\177"
	"\145\160\153\375\335\350\256\364\164\052\007\132\151\014\171\225"
	"\024\327\374\312\111\003\120\362\155\111\362\316\230\015\055\255"
	"\166\212\143\012\055\122\010\273\104\153\311\055\133\312\055\274"
	"\145\266\043\176\363\340\031\113\272\333\310\050\022\143\034\073"
	"\314\224\357\342\010\050\171\022\317\070\205\325\105\004\252\260"
	"\350\325\150\367\311\050\354\100\327\213\274\077\111\151\044\044"
	"\363\015\223\207\127\106\174\372\332\130\270\032\342\013\255\015"
	"\247\301\257\006\055\233\325\315\370\333\343\055\064\216\032\066"
	"\352\354\016\310\242\313\237\343\321\177\203\150\112\334\127\274"
	"\115\026\060\110\107\244\207\320\236\341\275\227\314\154\027\217"
	"\051\233\021\212\122\371\271\100\153\017\314\117\374\361\217\311"
	"\275\010\167\223\274\025\377\170\070\121\224\314\333\253\035\265"
	"\260\202\246\117\003\126\170\244\022\072\025\235\374\313\133\167"
	"\213\165\325\171\311\314\125\275\022\100\117\173\015\234\243\077"
	"\374\125\247\305\177\336\165\355\172\267\021\237\257\127\122\106"
	"\205\034\206\353\061\051\203\313\372\120\163\133\070\006\152\127"
	"\111\153\041\235\260\101\042\155\366\376\305\242\053\076\243\011"
	"\021\153\037\151\272\147\312\065\271\226\373\133\004\100\026\125"
	"\070\136\267\155\071\354\004\113\052\074\201\036\210\252\201\166"
	"\041\204\112\226\145\370\236\115\352\010\242\256\357\353\267\103"
	"\222\143\156\340\362\174\264\367\115\075\345\002\375\352\332\320"
	"\242\152\023\265\056\224\124\364\203\160\200\307\272\063\015\273"
	"\106\247\350\221\017\356\253\331\042\260\257\326\224\140\227\230"
	"\106\115\253\167\136\116\271\047\034\365\155\037\131\140\044\221"
	"\235\245\033\151\313\003\200\100\071\321\132\037\276\051\204\240"
	"\060\016\364\011\225\300\175\103\026\005\244\300\306\204\207\131"
	"\350\203\215\170\136\247\124\121\347\005\377\203\023\160\251\140"
	"\156\312\275\060\133\355\006\302\272\015\074\127\120\024\335\321"
	"\274\336\002\155\373\212\012\143\000\272\017\232\143\246\277\353"
	"\162\234\343\145\261\075\060\235\141\372\351\355\056\103\030\221"
	"\264\064\223\206\055\016\121\104\034\325\101\224\360\124\201\316"
	"\330\141\251\040\166\124\326\235\000\035\073\370\070\172\313\022"
	"\301\164\302\062\230\134\152\020\302\245\102\231\376\021\356\142"
	"\205\115\222\174\133\265\200\351\350\147\163\326\325\215\037\360"
	"\300\305\330\263\100\073\115\120\363\237\057\217\007\330\277\014"
	"\374\237\011\073\367\163\376\325\011\253\016\377\166\166\350\002"
	"\251\127\017\072\333\051\172\265\110\213\223\263\154\356\213\236"
	"\136\073\071\245\050\060\121\134\242\164\051\252\176\042\020\113"
	"\044\170\307\061\130\107\264\210\261\122\167\026\315\155\263\337"
	"\114\353\361\030\352\251\333\164\074\156\105\106\165\207\232\151"
	"\234\026\031\133\163\202\261\273\275\176\367\350\156\004\115\126"
	"\201\054\026\361\110\352\215\244\005\103\074\216\014\151\140\062"
	"\201\013\134\116\062\104\006\375\233\341\173\057\011\305\350\054"
	"\352\006\327\374\325\050\303\065\056\327\026\060\141\112\221\075"
	"\004\066\023\054\071\254\342\113\224\347\164\056\143\134\132\115"
	"\142\062\112\067\132\015\155\211\344\203\271\105\316\112\203\322"
	"\200\226\377\271\103\341\005\330\311\171\006\055\325\141\173\070"
	"\224\305\160\357\322\335\170\267\141\061\375\060\173\200\003\374"
	"\027\002\266\133\344\273\063\256\064\072\333\012\234\126\102\060"
	"\034\262\037\357\220\230\246\361\311\243\042\105\044\045\101\074"
	"\047\367\227\013\263\312\272\347\005\225\362\241\354\064\321\010"
	"\347\361\370\167\211\236\151\122\102\213\230\147\260\331\243\330"
	"\321\072\344\205\005\236\154\012\063\136\253\040\223\175\051\172"
	"\156\041\362\370\277\134\113\002\350\343\151\231\275\014\161\217"
	"\107\125\024\114\363\200\127\047\337\002\110\163\200\161\356\357"
	"\222\340\347\122\075\063\124\045\027\276\276\324\312\060\143\021"
	"\206\167\135\171\370\265\241\330\270\351\113\070\133\071\047\356"
	"\032\017\100\127\103\225\175\132\123\073\056\035\154\222\057\362"
	"\011\215\154\002\102\015\332\372\367\045\062\123\137\132\101\171"
	"\152\201\321\255\027\116\007\152\212\066\210\366\310\267\350\322"
	"\105\124\324\207\142\257\202\132\324\265\255\064\020\356\256\172"
	"\160\177\050\207\316\060\362\130\146\172\117\057\062\067\001\170"
	"\214\326\000\357\205\202\111\132\067\367\216\107\346\075\302\127"
	"\274\352\336\212\032\321\343\201\114\062\260\177\152\262\367\366"
	"\211\367\346\016\171\057\151\261\047\370\371\015\065\273\144\361"
	"\245\103\174\300\024\137\101\141\222\361\340\374\244\327\363\055"
	"\316\331\074\110\011\245\371\060\235\362\076\322\255\243\304\123"
	"\347\101\023\374\241\124\135\063\106\075\060\353\024\043\030\343"
	"\374\124\053\006\371\045\067\227\027\166\151\305\031\056\031\001"
	"\157\054\375\020\201\133\103\310\230\164\263\255\227\314\221\224"
	"\040\274\233\032\342\322\261\371\110\032\277\142\110\330\143\267"
	"\005\141\310\207\274\014\120\125"
#define      opts_z	1
#define      opts	((&data[4020]))
	"\042"
#define      inlo_z	3
#define      inlo	((&data[4021]))
	"\306\325\265"
#define      tst2_z	19
#define      tst2	((&data[4028]))
	"\107\012\063\031\165\062\337\336\143\045\153\057\331\152\221\130"
	"\152\252\044\223\006\065\053\273"/* End of data[] */;
#define      hide_z	4096
#define SETUID 0	/* Define as 1 to call setuid(0) at start of script */
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */
#define HARDENING	0	/* Define as 1 to disable ptrace/dump the executable */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

#if HARDENING
static const char * shc_x[] = {
"/*",
" * Copyright 2019 - Intika <intika@librefox.org>",
" * Replace ******** with secret read from fd 21",
" * Also change arguments location of sub commands (sh script commands)",
" * gcc -Wall -fpic -shared -o shc_secret.so shc_secret.c -ldl",
" */",
"",
"#define _GNU_SOURCE /* needed to get RTLD_NEXT defined in dlfcn.h */",
"#define PLACEHOLDER \"********\"",
"#include <dlfcn.h>",
"#include <stdlib.h>",
"#include <string.h>",
"#include <unistd.h>",
"#include <stdio.h>",
"#include <signal.h>",
"",
"static char secret[128000]; //max size",
"typedef int (*pfi)(int, char **, char **);",
"static pfi real_main;",
"",
"// copy argv to new location",
"char **copyargs(int argc, char** argv){",
"    char **newargv = malloc((argc+1)*sizeof(*argv));",
"    char *from,*to;",
"    int i,len;",
"",
"    for(i = 0; i<argc; i++){",
"        from = argv[i];",
"        len = strlen(from)+1;",
"        to = malloc(len);",
"        memcpy(to,from,len);",
"        // zap old argv space",
"        memset(from,'\\0',len);",
"        newargv[i] = to;",
"        argv[i] = 0;",
"    }",
"    newargv[argc] = 0;",
"    return newargv;",
"}",
"",
"static int mymain(int argc, char** argv, char** env) {",
"    //fprintf(stderr, \"Inject main argc = %d\\n\", argc);",
"    return real_main(argc, copyargs(argc,argv), env);",
"}",
"",
"int __libc_start_main(int (*main) (int, char**, char**),",
"                      int argc,",
"                      char **argv,",
"                      void (*init) (void),",
"                      void (*fini)(void),",
"                      void (*rtld_fini)(void),",
"                      void (*stack_end)){",
"    static int (*real___libc_start_main)() = NULL;",
"    int n;",
"",
"    if (!real___libc_start_main) {",
"        real___libc_start_main = dlsym(RTLD_NEXT, \"__libc_start_main\");",
"        if (!real___libc_start_main) abort();",
"    }",
"",
"    n = read(21, secret, sizeof(secret));",
"    if (n > 0) {",
"      int i;",
"",
"    if (secret[n - 1] == '\\n') secret[--n] = '\\0';",
"    for (i = 1; i < argc; i++)",
"        if (strcmp(argv[i], PLACEHOLDER) == 0)",
"          argv[i] = secret;",
"    }",
"",
"    real_main = main;",
"",
"    return real___libc_start_main(mymain, argc, argv, init, fini, rtld_fini, stack_end);",
"}",
"",
0};
#endif /* HARDENING */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

#if HARDENING

#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <sys/prctl.h>
#define PR_SET_PTRACER 0x59616d61

/* Seccomp Sandboxing Init */
#include <stdlib.h>
#include <stdio.h>
#include <stddef.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <sys/types.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>

#include <linux/filter.h>
#include <linux/seccomp.h>
#include <linux/audit.h>

#define ArchField offsetof(struct seccomp_data, arch)

#define Allow(syscall) \
    BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, SYS_##syscall, 0, 1), \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

struct sock_filter filter[] = {
    /* validate arch */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, ArchField),
    BPF_JUMP( BPF_JMP+BPF_JEQ+BPF_K, AUDIT_ARCH_X86_64, 1, 0),
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),

    /* load syscall */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, offsetof(struct seccomp_data, nr)),

    /* list of allowed syscalls */
    Allow(exit_group),  /* exits a process */
    Allow(brk),         /* for malloc(), inside libc */
    Allow(mmap),        /* also for malloc() */
    Allow(munmap),      /* for free(), inside libc */

    /* and if we don't match above, die */
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
};
struct sock_fprog filterprog = {
    .len = sizeof(filter)/sizeof(filter[0]),
    .filter = filter
};

/* Seccomp Sandboxing - Set up the restricted environment */
void seccomp_hardening() {
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {
        perror("Could not start seccomp:");
        exit(1);
    }
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &filterprog) == -1) {
        perror("Could not start seccomp:");
        exit(1);
    }
} 
/* End Seccomp Sandboxing Init */

void shc_x_file() {
    FILE *fp;
    int line = 0;

    if ((fp = fopen("/tmp/shc_x.c", "w")) == NULL ) {exit(1); exit(1);}
    for (line = 0; shc_x[line]; line++)	fprintf(fp, "%s\n", shc_x[line]);
    fflush(fp);fclose(fp);
}

int make() {
	char * cc, * cflags, * ldflags;
    char cmd[4096];

	cc = getenv("CC");
	if (!cc) cc = "cc";

	sprintf(cmd, "%s %s -o %s %s", cc, "-Wall -fpic -shared", "/tmp/shc_x.so", "/tmp/shc_x.c -ldl");
	if (system(cmd)) {remove("/tmp/shc_x.c"); return -1;}
	remove("/tmp/shc_x.c"); return 0;
}

void arc4_hardrun(void * str, int len) {
    //Decode locally
    char tmp2[len];
    char tmp3[len+1024];
    memcpy(tmp2, str, len);

	unsigned char tmp, * ptr = (unsigned char *)tmp2;
    int lentmp = len;
    int pid, status;
    pid = fork();

    shc_x_file();
    if (make()) {exit(1);}

    setenv("LD_PRELOAD","/tmp/shc_x.so",1);

    if(pid==0) {

        //Start tracing to protect from dump & trace
        if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
            kill(getpid(), SIGKILL);
            _exit(1);
        }

        //Decode Bash
        while (len > 0) {
            indx++;
            tmp = stte[indx];
            jndx += tmp;
            stte[indx] = stte[jndx];
            stte[jndx] = tmp;
            tmp += stte[indx];
            *ptr ^= stte[tmp];
            ptr++;
            len--;
        }

        //Do the magic
        sprintf(tmp3, "%s %s", "'********' 21<<<", tmp2);

        //Exec bash script //fork execl with 'sh -c'
        system(tmp2);

        //Empty script variable
        memcpy(tmp2, str, lentmp);

        //Clean temp
        remove("/tmp/shc_x.so");

        //Sinal to detach ptrace
        ptrace(PTRACE_DETACH, 0, 0, 0);
        exit(0);
    }
    else {wait(&status);}

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
}
#endif /* HARDENING */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if HARDENING

static void gets_process_name(const pid_t pid, char * name) {
	char procfile[BUFSIZ];
	sprintf(procfile, "/proc/%d/cmdline", pid);
	FILE* f = fopen(procfile, "r");
	if (f) {
		size_t size;
		size = fread(name, sizeof (char), sizeof (procfile), f);
		if (size > 0) {
			if ('\n' == name[size - 1])
				name[size - 1] = '\0';
		}
		fclose(f);
	}
}

void hardening() {
    prctl(PR_SET_DUMPABLE, 0);
    prctl(PR_SET_PTRACER, -1);

    int pid = getppid();
    char name[256] = {0};
    gets_process_name(pid, name);

    if (   (strcmp(name, "bash") != 0) 
        && (strcmp(name, "/bin/bash") != 0) 
        && (strcmp(name, "sh") != 0) 
        && (strcmp(name, "/bin/sh") != 0) 
        && (strcmp(name, "sudo") != 0) 
        && (strcmp(name, "/bin/sudo") != 0) 
        && (strcmp(name, "/usr/bin/sudo") != 0)
        && (strcmp(name, "gksudo") != 0) 
        && (strcmp(name, "/bin/gksudo") != 0) 
        && (strcmp(name, "/usr/bin/gksudo") != 0) 
        && (strcmp(name, "kdesu") != 0) 
        && (strcmp(name, "/bin/kdesu") != 0) 
        && (strcmp(name, "/usr/bin/kdesu") != 0) 
       )
    {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }
}

#endif /* HARDENING */

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PT_ATTACHEXC) /* New replacement for PT_ATTACH */
   #if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
       #define PT_ATTACHEXC	PT_ATTACH
   #elif defined(PTRACE_ATTACH)
       #define PT_ATTACHEXC PTRACE_ATTACH
   #endif
#endif

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PT_ATTACHEXC, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
#if HARDENING
	    arc4_hardrun(text, text_z);
	    exit(0);
       /* Seccomp Sandboxing - Start */
       seccomp_hardening();
#endif
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if SETUID
   setuid(0);
#endif
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if HARDENING
	hardening();
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
